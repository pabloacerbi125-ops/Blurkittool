{% extends 'base.html' %}
{% block content %}
<div class="mods-wrapper row g-4">
  <div class="col-lg-8 col-12">
    <div class="mods-header">
      <div>
        <p class="eyebrow">Listado</p>
        <h4 class="mods-title">Mods</h4>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button onclick="location.reload()" class="btn btn-sm btn-outline-primary pill-btn">üîÑ Actualizar</button>
        <span class="pill-muted">Total: {{ prohibidos|length + permitidos|length }}</span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card bad">
        <div class="stat-label">Prohibidos</div>
        <div class="stat-value">{{ prohibidos|length }}</div>
      </div>
      <div class="stat-card good">
        <div class="stat-label">Permitidos</div>
        <div class="stat-value">{{ permitidos|length }}</div>
      </div>
      <div class="stat-card neutral">
        <div class="stat-label">Total</div>
        <div class="stat-value">{{ prohibidos|length + permitidos|length }}</div>
      </div>
    </div>

    <div class="search-card">
      <form method="get" action="/mods" class="d-flex flex-wrap gap-2">
        <div class="flex-grow-1">
          <input type="text" name="search" class="form-control" placeholder="üîç Buscar por nombre o alias" value="{{ search_term or '' }}" autocomplete="off">
        </div>
        <button type="submit" class="btn btn-primary">Buscar</button>
        {% if search_term %}
        <a href="/mods" class="btn btn-secondary">Limpiar</a>
        {% endif %}
      </form>
      {% if search_term %}
      <div class="mt-2 search-hint">Mostrando resultados para: <strong>{{ search_term }}</strong></div>
      {% endif %}
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">{{ error }}</div>
    {% endif %}

    <div class="mods-sections">
      <div class="mods-section">
        <div class="section-title with-chip">
          <span class="chip chip-good">Permitidos</span>
          <span class="muted">{{ permitidos|length }} items</span>
        </div>
        <div class="mods-list">
          {% for idx, m in permitidos %}
          <div class="mod-card mod-card-good">
            <div class="mod-main">
              <div class="mod-title">{{ m.name }}</div>
              <div class="mod-meta">
                <span class="tag">{{ m.category or 'Sin categor√≠a' }}</span>
                <span class="tag">{{ m.platform or 'Sin plataforma' }}</span>
                {% if m.aliases %}
                  <span class="tag alt">Alias: {{ m.aliases }}</span>
                {% endif %}
              </div>
              {% if m.description %}
              <div class="mod-desc">{{ m.description }}</div>
              {% endif %}
            </div>
            {% if current_user.can_edit() %}
            <div class="mod-actions">
              <a href="/edit/{{ idx }}" class="btn btn-sm btn-outline-light btn-sm-custom">Editar</a>
              <button class="btn btn-sm btn-outline-danger btn-sm-custom delete-btn" data-delete-idx="{{ idx }}">Eliminar</button>
            </div>
            {% endif %}
          </div>
          {% else %}
          <div class="empty-state">No hay mods permitidos.</div>
          {% endfor %}
        </div>
      </div>

      <div class="mods-section">
        <div class="section-title with-chip">
          <span class="chip chip-bad">Prohibidos</span>
          <span class="muted">{{ prohibidos|length }} items</span>
        </div>
        <div class="mods-list">
          {% for idx, m in prohibidos %}
          <div class="mod-card mod-card-bad">
            <div class="mod-main">
              <div class="mod-title">{{ m.name }}</div>
              <div class="mod-meta">
                <span class="tag">{{ m.category or 'Sin categor√≠a' }}</span>
                <span class="tag">{{ m.platform or 'Sin plataforma' }}</span>
                {% if m.aliases %}
                  <span class="tag alt">Alias: {{ m.aliases }}</span>
                {% endif %}
              </div>
              {% if m.description %}
              <div class="mod-desc">{{ m.description }}</div>
              {% endif %}
            </div>
            {% if current_user.can_edit() %}
            <div class="mod-actions">
              <a href="/edit/{{ idx }}" class="btn btn-sm btn-outline-light btn-sm-custom">Editar</a>
              <button class="btn btn-sm btn-outline-danger btn-sm-custom delete-btn" data-delete-idx="{{ idx }}">Eliminar</button>
            </div>
            {% endif %}
          </div>
          {% else %}
          <div class="empty-state">No hay mods prohibidos.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  {% if current_user.can_edit() %}
  <div class="col-lg-4">
    <div class="card add-card p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Agregar mod</h5>
        <span class="pill-muted">Nuevo</span>
      </div>
      <form action="/add_mod" method="post" class="form-modern">
        <label class="form-label">Nombre*</label>
        <input name="name" class="form-control" placeholder="Nombre" required>
        <div class="row g-2">
          <div class="col">
            <label class="form-label">Categor√≠a</label>
            <input name="category" class="form-control" placeholder="Ej: Texturas">
          </div>
          <div class="col">
            <label class="form-label">Plataforma</label>
            <input name="platform" class="form-control" placeholder="Ej: Java/Bedrock">
          </div>
        </div>
        <label class="form-label">Alias (coma-separados)</label>
        <input name="alias" class="form-control" placeholder="alias1, alias2">
        <label class="form-label">Descripci√≥n</label>
        <input name="description" class="form-control" placeholder="Descripci√≥n breve">
        <label class="form-label">Estado</label>
        <select name="status" class="form-select">
          <option value="prohibido">Prohibido</option>
          <option value="permitido">Permitido</option>
        </select>
        <div class="d-flex mt-3 gap-2">
          <button class="btn btn-primary flex-grow-1">Guardar</button>
          <a href="/menu" class="btn btn-secondary">Volver</a>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
</div>

<script>
  // Protecci√≥n agresiva de inputs (excepto b√∫squeda)
  (function() {
    // Guardar referencias originales
    var originalAddEventListener = EventTarget.prototype.addEventListener;
    var protectedInputs = new WeakSet();
    
    // Marcar todos los inputs como protegidos al cargar (excepto el de b√∫squeda)
    function protectInputs() {
      document.querySelectorAll('input, textarea, select').forEach(function(el) {
        // No proteger el input de b√∫squeda
        if (el.name === 'search') {
          return;
        }
        
        protectedInputs.add(el);
        Object.defineProperty(el, 'disabled', {
          get: function() { return false; },
          set: function() { },
          configurable: true
        });
      });
    }
    
    // Ejecutar inmediatamente y en DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', protectInputs);
    } else {
      protectInputs();
    }
    
    // Re-proteger cada 100ms
    setInterval(protectInputs, 100);
  })();
  
  // Manejar botones de eliminar
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.delete-btn').forEach(function(btn) {
      btn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var idx = this.getAttribute('data-delete-idx');
        
        if (confirm('¬øEliminar este mod?')) {
          // Crear formulario y enviarlo
          var form = document.createElement('form');
          form.method = 'POST';
          form.action = '/delete/' + idx;
          document.body.appendChild(form);
          form.submit();
        }
        return false;
      };
    });
  });
</script>

{% endblock %}
