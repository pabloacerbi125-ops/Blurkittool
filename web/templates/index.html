{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-lg-8">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0" style="color: #ffffff;">Lista de mods</h4>
      <div class="d-flex align-items-center gap-2">
        <button onclick="location.reload()" class="btn btn-sm btn-outline-primary" style="border-color: #ff8c42; color: #ff8c42;">
          ðŸ”„ Actualizar
        </button>
        <div style="color: #b8c1ca;">Total: {{ prohibidos|length + permitidos|length }}</div>
      </div>
    </div>
    
    <!-- Barra de bÃºsqueda -->
    <div class="mb-3">
      <form method="get" action="/mods" class="d-flex gap-2">
        <input type="text" name="search" class="form-control" placeholder="ðŸ” Buscar mod por nombre o alias..." value="{{ search_term or '' }}" style="background: var(--panel); border: 1px solid var(--card-border); color: #ffffff;" autocomplete="off">
        <button type="submit" class="btn btn-primary">Buscar</button>
        {% if search_term %}
        <a href="/mods" class="btn btn-secondary">Limpiar</a>
        {% endif %}
      </form>
      {% if search_term %}
      <div class="mt-2" style="color: #ffc107;">
        Mostrando resultados para: <strong>"{{ search_term }}"</strong>
      </div>
      {% endif %}
    </div>
    
    {% if error %}
    <div class="alert alert-danger" role="alert">
      {{ error }}
    </div>
    {% endif %}

    <div class="row">
      <div class="col-md-6 left-col">
        <div class="section-title" style="color: #ff6b6b; font-weight: 700;">Prohibidos</div>
        {% for idx, m in prohibidos %}
        <div class="card-mod d-flex justify-content-between align-items-start">
          <div>
            <div class="title">âœ— {{ m.name }}</div>
            <div class="meta">{{ m.category or '-' }} â€¢ {{ m.platform or '-' }}</div>
          </div>
          {% if current_user.can_edit() %}
          <div class="btn-group">
            <a href="/edit/{{ idx }}" class="btn btn-sm btn-outline-light btn-sm-custom">Editar</a>
            <button class="btn btn-sm btn-outline-danger btn-sm-custom delete-btn" data-delete-idx="{{ idx }}">Eliminar</button>
          </div>
          {% endif %}
        </div>
        {% else %}
        <div class="card-mod">(ninguno)</div>
        {% endfor %}
      </div>

      <div class="col-md-6 left-col">
        <div class="section-title" style="color: #51cf66; font-weight: 700;">Permitidos</div>
        {% for idx, m in permitidos %}
        <div class="card-mod d-flex justify-content-between align-items-start">
          <div>
            <div class="title">âœ” {{ m.name }}</div>
            <div class="meta">{{ m.category or '-' }} â€¢ {{ m.platform or '-' }}</div>
          </div>
          {% if current_user.can_edit() %}
          <div class="btn-group">
            <a href="/edit/{{ idx }}" class="btn btn-sm btn-outline-light btn-sm-custom">Editar</a>
            <button class="btn btn-sm btn-outline-danger btn-sm-custom delete-btn" data-delete-idx="{{ idx }}">Eliminar</button>
          </div>
          {% endif %}
        </div>
        {% else %}
        <div class="card-mod">(ninguno)</div>
        {% endfor %}
      </div>
    </div>

  </div>

  {% if current_user.can_edit() %}
  <div class="col-lg-4 right-col">
    <div class="card p-3" style="background:var(--panel); border:1px solid var(--card-border)">
      <h5 class="mb-3" style="color: #ffffff;">Agregar mod</h5>
      <form action="/add_mod" method="post">
        <div class="mb-2">
          <input name="name" class="form-control" placeholder="Nombre" required>
        </div>
        <div class="mb-2 d-flex gap-2">
          <input name="category" class="form-control" placeholder="Categoria">
          <input name="platform" class="form-control" placeholder="Plataforma">
        </div>
        <div class="mb-2">
          <input name="alias" class="form-control" placeholder="Alias (coma-separados)">
        </div>
        <div class="mb-2">
          <input name="description" class="form-control" placeholder="DescripciÃ³n">
        </div>
        <div class="mb-2">
          <select name="status" class="form-select">
            <option value="prohibido">Prohibido</option>
            <option value="permitido">Permitido</option>
          </select>
        </div>
        <div class="d-flex">
          <button class="btn btn-primary">Guardar</button>
          <a href="/" class="btn btn-secondary ms-2">Volver</a>
        </div>
      </form>
      <hr class="my-3" />
      <p class="footer-note">mods.json se guarda en la carpeta del proyecto.</p>
    </div>
  </div>
  {% endif %}
</div>

<script>
  // ProtecciÃ³n agresiva de inputs (excepto bÃºsqueda)
  (function() {
    // Guardar referencias originales
    var originalAddEventListener = EventTarget.prototype.addEventListener;
    var protectedInputs = new WeakSet();
    
    // Marcar todos los inputs como protegidos al cargar (excepto el de bÃºsqueda)
    function protectInputs() {
      document.querySelectorAll('input, textarea, select').forEach(function(el) {
        // No proteger el input de bÃºsqueda
        if (el.name === 'search') {
          return;
        }
        
        protectedInputs.add(el);
        Object.defineProperty(el, 'disabled', {
          get: function() { return false; },
          set: function() { },
          configurable: true
        });
      });
    }
    
    // Ejecutar inmediatamente y en DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', protectInputs);
    } else {
      protectInputs();
    }
    
    // Re-proteger cada 100ms
    setInterval(protectInputs, 100);
  })();
  
  // Manejar botones de eliminar
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.delete-btn').forEach(function(btn) {
      btn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var idx = this.getAttribute('data-delete-idx');
        
        if (confirm('Â¿Eliminar este mod?')) {
          // Crear formulario y enviarlo
          var form = document.createElement('form');
          form.method = 'POST';
          form.action = '/delete/' + idx;
          document.body.appendChild(form);
          form.submit();
        }
        return false;
      };
    });
  });
</script>

{% endblock %}
